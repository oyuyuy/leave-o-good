<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>è¯•è¯•æˆ‘è¯•è¯•å¥½-è§†é¢‘ä¸‹è½½å·¥å…·Web 1.0</title>

<style>
/* ========== é«˜çº§åŠ¨æ€èƒŒæ™¯ + åŠ¨ç”» ========== */
body{
  font-family: "Segoe UI", sans-serif;
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
  background-size: 200% 200%;
  animation: bgAnimate 12s ease infinite;
  color:#e5e7eb;
  padding:20px;
  margin:0;
  min-height: 100vh;
}
@keyframes bgAnimate {
  0% { background-position: 0% 0%; }
  50% { background-position: 100% 100%; }
  100% { background-position: 0% 0%; }
}

.container{
  max-width:1000px;
  margin:auto;
  background: rgba(15, 23, 42, 0.7);
  padding: 20px;
  border-radius: 12px;
  border: 1px solid rgba(51, 65, 85, 0.3);
}
h1{
  text-align:center;
  margin-bottom: 8px;
  text-shadow: 0 0 8px rgba(37, 99, 235, 0.2);
}
.subtitle{
  text-align:center;
  color:#94a3b8;
  font-size:16px;
  font-weight:normal;
  margin-top:0;
  margin-bottom:20px;
}
textarea{
  width:100%;
  height:140px;
  background:#020617;
  color:#e5e7eb;
  border:1px solid #334155;
  padding:10px;
  border-radius: 6px;
  outline: none;
  transition: border 0.3s;
  box-sizing: border-box;
}
textarea:focus{
  border-color: #2563eb;
  box-shadow: 0 0 8px rgba(37, 99, 235, 0.2);
}
button{
  background:#2563eb;
  border:none;
  padding:8px 14px;
  color:white;
  margin:4px;
  cursor:pointer;
  border-radius: 6px;
  transition: all 0.2s ease;
}
button:hover{
  background:#1d4ed8;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
}
button:active{
  transform: translateY(0);
}
button.secondary{
  background:#475569;
}
button.secondary:hover{
  background:#334155;
}
button.danger{
  background:#b91c1c;
}
button.danger:hover{
  background:#991b1b;
}
.panel{
  margin-top:20px;
  padding:12px;
  border:1px solid #334155;
  border-radius:6px;
  background: rgba(2, 6, 23, 0.6);
}
.video-list{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.video-item{
  width:50px;
  text-align:center;
  padding:6px 0;
  background:#020617;
  border:1px solid #334155;
  cursor:pointer;
  border-radius: 4px;
  transition: all 0.2s;
}
.video-item:hover{
  border-color: #2563eb;
}
.video-item.checked{
  background:#2563eb;
  border-color: #2563eb;
  color: #fff;
}
#log{
  height:200px;
  overflow:auto;
  background:#020617;
  padding:8px;
  font-size:13px;
  border-radius: 4px;
}
input[type=text]{
  background:#020617;
  color:#e5e7eb;
  border:1px solid #334155;
  padding:4px 8px;
  border-radius: 4px;
  outline: none;
}
input[type=text]:focus{
  border-color: #2563eb;
}
input[type=checkbox]{
  accent-color: #2563eb;
}

/* ================= å…è´£å£°æ˜é®ç½© ================= */
#disclaimerMask{
  position:fixed;
  inset:0;
  background:rgba(2,6,23,0.98);
  z-index:9999;
  display:flex;
  align-items:center;
  justify-content:center;
  backdrop-filter: blur(8px);
}
#disclaimerBox{
  width:600px;
  max-width:90%;
  background:#020617;
  border:1px solid #334155;
  border-radius:10px;
  padding:20px;
  box-shadow: 0 0 30px rgba(0,0,0,0.5);
}
#disclaimerBox h2{
  margin-top:0;
  text-align:center;
}
#disclaimerContent{
  font-size:14px;
  line-height:1.6;
  max-height:260px;
  overflow:auto;
  margin:15px 0;
  color:#cbd5f5;
}
#disclaimerActions{
  text-align:center;
}
#disclaimerActions button{
  width:160px;
  margin:0 10px;
}

/* æ–°å¢ï¼šå›¾ç‰‡æ ·å¼ï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´ */
.footer-img {
  margin-bottom: 30px; /* è°ƒæ•´ä¸ºåº•éƒ¨é—´è·ï¼Œé€‚é…é¡¶éƒ¨ä½ç½® */
  text-align: center;
}
.footer-img img {
  max-width: 100%;
  height: auto;
  border-radius: 8px;
}
</style>
</head>

<body>

<!-- ============ å…è´£å£°æ˜é®ç½© ============ -->
<div id="disclaimerMask" style="display:flex;">
  <div id="disclaimerBox">
    <h2>å…è´£å£°æ˜</h2>
    <div id="disclaimerContent">
      <p>åœ¨ä½¿ç”¨æœ¬ç½‘ç«™æä¾›çš„æœåŠ¡å‰ï¼Œè¯·æ‚¨åŠ¡å¿…ä»”ç»†é˜…è¯»å¹¶å……åˆ†ç†è§£æœ¬å…è´£å£°æ˜å†…å®¹ã€‚</p>
      <p>1. æœ¬ç½‘ç«™ä»…ä½œä¸ºæŠ€æœ¯ç ”ç©¶ã€å­¦ä¹ ä¸æµ‹è¯•ç”¨é€”ï¼Œæ‰€æä¾›çš„è§£æä¸ä¸‹è½½åŠŸèƒ½ä¸é’ˆå¯¹ä»»ä½•ç‰¹å®šå¹³å°ã€‚</p>
      <p>2. ç”¨æˆ·åº”ç¡®ä¿å…¶è·å–ã€ä½¿ç”¨ã€ä¸‹è½½çš„å†…å®¹ä¸ä¾µçŠ¯ä»»ä½•ç¬¬ä¸‰æ–¹çš„åˆæ³•æƒç›Šï¼ŒåŒ…æ‹¬ä½†ä¸é™äºè‘—ä½œæƒã€éšç§æƒåŠå…¶ä»–åˆæ³•æƒåˆ©ã€‚</p>
      <p>3. å› ç”¨æˆ·ä½¿ç”¨æœ¬å·¥å…·æ‰€äº§ç”Ÿçš„ä»»ä½•æ³•å¾‹è´£ä»»ã€çº çº·æˆ–æŸå¤±ï¼Œå‡ç”±ç”¨æˆ·æœ¬äººè‡ªè¡Œæ‰¿æ‹…ï¼Œä¸æœ¬ç½‘ç«™åŠå¼€å‘è€…æ— å…³ã€‚</p>
      <p>4. æœ¬ç½‘ç«™ä¸å¯¹ä¸‹è½½å†…å®¹çš„åˆæ³•æ€§ã€å®Œæ•´æ€§ã€å‡†ç¡®æ€§æˆ–å¯ç”¨æ€§ä½œå‡ºä»»ä½•å½¢å¼çš„ä¿è¯ã€‚</p>
      <p>5. ä¸€æ—¦ç‚¹å‡»"åŒæ„å¹¶ç»§ç»­"ï¼Œå³è§†ä¸ºæ‚¨å·²é˜…è¯»ã€ç†è§£å¹¶åŒæ„æœ¬å…è´£å£°æ˜çš„å…¨éƒ¨å†…å®¹ã€‚</p>
    </div>
    <div id="disclaimerActions">
      <button class="secondary" onclick="declineDisclaimer()">ä¸åŒæ„</button>
      <button onclick="acceptDisclaimer()">åŒæ„å¹¶ç»§ç»­</button>
    </div>
  </div>
</div>

<div class="container">
  <!-- å›¾ç‰‡ç§»åˆ°æœ€ä¸Šæ–¹ -->
  <div class="footer-img">
    <img src="/static/meishaonv.png" alt="é¡¶éƒ¨å›¾ç‰‡">
  </div>

  <!-- åŸæ ‡é¢˜å·²åˆ é™¤ -->
  <textarea id="inputContent" placeholder="æŒ‰F12æ‰“å¼€å‘è€…å·¥å…·é¢æ¿ï¼Œç‚¹å‡»<å…ƒç´ >æ ‡ç­¾ï¼Œæ‰¾åˆ°<body class=>è¿™ä¸€è¡Œï¼Œå³é”®<å¤åˆ¶>ï¼Œ<å¤åˆ¶OuterHTML>ï¼Œç„¶åå°†å†…å®¹ç²˜è´´åˆ°æ­¤å¤„ã€‚"></textarea>
  <br>
  <button id="parseBtn" onclick="parseLinks()">è§£æå†…å®¹</button>
  <button onclick="getInviteCode()">è·å–é‚€è¯·ç </button>
  <button onclick="openTutorial()">ä½¿ç”¨æ•™ç¨‹</button>

  <div class="panel">
    <b>è§†é¢‘åˆ—è¡¨</b><br>
    <button class="secondary" onclick="selectAll()">å…¨é€‰</button>
    <button class="secondary" onclick="clearAll()">å–æ¶ˆå…¨é€‰</button>
    <div class="video-list" id="list"></div>
  </div>

  <div class="panel">
    <b>ä¸‹è½½è®¾ç½®</b><br>

    <div style="font-size:14px; color:#94a3b8; margin:8px 0;">
      è¯´æ˜ï¼šè§†é¢‘å°†ç”±æœåŠ¡å™¨åå°ä»£ç æŒ‰é¡ºåºé‡å‘½ååï¼Œè‡ªåŠ¨æ‰“åŒ…ä¸ºä¸€ä¸ªå‹ç¼©æ–‡ä»¶ï¼ˆZIPï¼‰ä¾›æ‚¨ä¸‹è½½ã€‚<br>
      è§†é¢‘æ•°é‡è¾ƒå¤šæ—¶ï¼Œè¯·è€å¿ƒç­‰å¾…æ‰“åŒ…å®Œæˆã€‚å¦‚æœæç¤º"è¯·æ±‚å¼‚å¸¸"å¯ä»¥å†æ¬¡ç‚¹å‡»"å¼€å§‹ä¸‹è½½"
    </div>

    <button id="downloadBtn" onclick="startDownload()">
      å¼€å§‹ä¸‹è½½
    </button>
  </div>

  <div class="panel">
    <b>è¿è¡Œæ—¥å¿—</b>
    <div id="log"></div>
  </div>

</div>

<script>
let videoUrls = [];
let selected = [];
let customNames = {};

/* ========== å…è´£å£°æ˜é€»è¾‘ï¼ˆåˆ·æ–°å¿…ç°ï¼Œæ— ç¼“å­˜ï¼‰ ========== */
function acceptDisclaimer(){
  document.getElementById("disclaimerMask").style.display = "none";
}

function declineDisclaimer(){
  alert("æ‚¨å¿…é¡»åŒæ„å…è´£å£°æ˜åæ‰èƒ½ä½¿ç”¨æœ¬ç½‘ç«™ã€‚");
}

function openTutorial() {
  // æ‰“å¼€æ–°æ ‡ç­¾é¡µè·³è½¬è‡³æ•™ç¨‹é“¾æ¥
  window.open("https://www.bilibili.com/video/BV1Kk6ZB3EG8", "_blank");
  log("ğŸ“š å·²ä¸ºæ‚¨æ‰“å¼€ä½¿ç”¨æ•™ç¨‹é¡µé¢");
}

/* ========== åŸæœ‰åŠŸèƒ½ä»£ç  ========== */
function log(msg){
  const el = document.getElementById("log");
  el.innerHTML += msg + "<br>";
  el.scrollTop = el.scrollHeight;
}

function parseLinks(){
  const btn = document.getElementById("parseBtn");
  if(!btn){
    console.error("parseBtn ä¸å­˜åœ¨");
    return;
  }

  const content = inputContent.value.trim();
  if(!content){
    log("âš  è¾“å…¥ä¸ºç©º");
    return;
  }

  btn.disabled = true;
  btn.innerText = "æ­£åœ¨è§£æä¸­...";
  btn.style.opacity = "0.6";
  btn.style.cursor = "not-allowed";

  fetch("/api/parse",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ content })
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.code !== 200){
      log("âŒ è§£æå¤±è´¥");
      restore();
      return;
    }

    videoUrls = d.data.video_urls || [];
    renderList();
    log(`âœ” è§£æå®Œæˆï¼Œå…± ${videoUrls.length} ä¸ªè§†é¢‘`);
    inputContent.value = "";
    restore();
  })
  .catch(e=>{
    log("âŒ è§£æå¼‚å¸¸ï¼š" + e.message);
    restore();
  });

  function restore(){
    btn.disabled = false;
    btn.innerText = "è§£æå†…å®¹";
    btn.style.opacity = "1";
    btn.style.cursor = "pointer";
  }
}

// ä¿®å¤æ ¸å¿ƒï¼šè§†é¢‘åˆ—è¡¨æ¸²æŸ“+ç´¢å¼•æ˜ å°„
function renderList(){
  list.innerHTML="";
  selected=[];
  customNames={}; // æ¸…ç©ºåç§°æ˜ å°„

  videoUrls.forEach((u,i)=>{
    const idx=i+1; // è§†é¢‘åºå·ï¼ˆ1å¼€å§‹ï¼Œç”¨äºæ˜¾ç¤ºï¼‰
    const div=document.createElement("div");
    div.className="video-item";
    div.innerText=idx.toString().padStart(2,"0");
    div.dataset.index = i; // å­˜å‚¨åŸå§‹ç´¢å¼•ï¼ˆ0å¼€å§‹ï¼‰ï¼Œå…³é”®ï¼
    div.onclick=()=>{
      div.classList.toggle("checked");
      const rawIndex = parseInt(div.dataset.index); // è·å–åŸå§‹ç´¢å¼•
      if(div.classList.contains("checked")){
        // é€‰ä¸­æ—¶ï¼šselectedå­˜å‚¨åŸå§‹ç´¢å¼•ï¼ˆ0å¼€å§‹ï¼‰
        selected.push(rawIndex);
        customNames[rawIndex] = "è§†é¢‘" + idx; // åç§°æŒ‰æ˜¾ç¤ºåºå·å‘½åï¼Œé”®ä¸ºåŸå§‹ç´¢å¼•
      }else{
        // å–æ¶ˆé€‰ä¸­æ—¶ï¼šåˆ é™¤å¯¹åº”åŸå§‹ç´¢å¼•
        selected = selected.filter(v=>v!==rawIndex);
        delete customNames[rawIndex];
      }
    }
    list.appendChild(div);
  });
}

// ä¿®å¤å…¨é€‰é€»è¾‘
function selectAll(){
  document.querySelectorAll(".video-item").forEach(d=>{
    if(!d.classList.contains("checked")) d.click();
  });
}

// ä¿®å¤å–æ¶ˆå…¨é€‰é€»è¾‘
function clearAll(){
  document.querySelectorAll(".video-item.checked").forEach(d=>{
    d.classList.remove("checked");
  });
  selected=[];
  customNames={};
}

// ä¿®å¤æ ¸å¿ƒï¼šä¸‹è½½è¯·æ±‚å‚æ•°ç»„è£…
function startDownload(){
  if(selected.length === 0){
    log("âš  æœªé€‰æ‹©è§†é¢‘");
    return;
  }

  const btn = document.getElementById("downloadBtn");

  // ç¦ç”¨æŒ‰é’®
  btn.disabled = true;
  btn.innerText = "å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...";
  btn.style.opacity = "0.6";
  btn.style.cursor = "not-allowed";

  log("ğŸ“¥ å·²é€‰æ‹©ä¸‹è½½è§†é¢‘ï¼š");

  const downloadLinks = [];
  const downloadNames = {};

  selected.forEach((rawIndex, idx) => {
    const videoNo = rawIndex + 1;
    const videoUrl = videoUrls[rawIndex];

    downloadLinks.push(videoUrl);
    downloadNames[idx] = customNames[rawIndex] || ("è§†é¢‘" + videoNo);

    log("â†’ è§†é¢‘ " + videoNo.toString().padStart(2, "0"));
  });

  fetch("/api/download", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      selected_links: downloadLinks,
      custom_names: downloadNames
    })
  })
  .then(r => r.json())
  .then(d => {
    if(d.code !== 200){
      log("âŒ ä¸‹è½½ä»»åŠ¡å¤±è´¥");
      restoreButton();
      return;
    }

    if(d.data && d.data.logs){
      d.data.logs.forEach(l => log(l));
    }

    if(d.data && d.data.zip_id){
      const zipUrl = "/api/zip/" + d.data.zip_id;

      log("â¬‡ æ­£åœ¨è°ƒç”¨æµè§ˆå™¨ä¸‹è½½æ•´ç†å¥½çš„è§†é¢‘åŒ…â€¦");

      const a = document.createElement("a");
      a.href = zipUrl;
      a.download = "";
      a.style.display = "none";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      log("âœ” ä¸‹è½½ä»»åŠ¡å·²å®Œæˆï¼ŒæœåŠ¡å™¨å°†è‡ªåŠ¨æ¸…ç†æ–‡ä»¶");
    }else{
      log("âš  æœªè·å–åˆ°ä¸‹è½½æ–‡ä»¶");
    }

    restoreButton();
  })
  .catch(e => {
    log("âŒ è¯·æ±‚å¼‚å¸¸ï¼š" + e.message);
    restoreButton();
  });

  // æ¢å¤æŒ‰é’®å‡½æ•°
  function restoreButton(){
    btn.disabled = false;
    btn.innerText = "å¼€å§‹ä¸‹è½½";
    btn.style.opacity = "1";
    btn.style.cursor = "pointer";
  }
}

/* ========== è·å–é‚€è¯·ç é€»è¾‘ ========== */
function getInviteCode() {
  log("ğŸ” æ­£åœ¨è·å–é‚€è¯·ç ...");
  fetch("/api/get_invite_code", {
    method: "GET",
    headers: { "Content-Type": "application/json" }
  })
  .then(r => r.json())
  .then(d => {
    if (d.code !== 200) {
      log(`âŒ è·å–é‚€è¯·ç å¤±è´¥ï¼š${d.msg}`);
      return;
    }
    document.getElementById("inputContent").value = d.data.invite_code;
    log(`âœ” é‚€è¯·ç è·å–æˆåŠŸï¼Œå·²å¡«å…¥è¾“å…¥æ¡†`);
  })
  .catch(e => {
    log(`âŒ è·å–é‚€è¯·ç å¼‚å¸¸ï¼š${e.message}`);
  });
}
</script>

</body>
</html>
